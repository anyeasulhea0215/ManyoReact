<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" th:href="@{/assets/css/mypage.css}"/>
    <title>마이페이지</title>

    <style>
        .recently-products {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  margin-top: 20px;
  text-align: center;
  padding: 30px 0;
}

.recently-products .product {
  width: 18%; /* 100% / 5열 = 20% → 여백 고려해서 18% */
  text-align: center;
}

.recently-products .product img {
  width: 100%;
  height: auto;
  max-height: 140px;
  object-fit: cover;
  border: 1px solid #ddd;
  border-radius: 8px;
}

.recently-products .product p {
  font-size: 14px;
  margin-top: 8px;
  color: #333;
}

    </style>
</head>
<body th:attr="data-user-id=${memberInfo != null ? memberInfo.id : ''}">

   <header th:replace="fragments/header :: my-header"></header>


    <main>
        <aside>
            <h2>마이페이지</h2>

            <h3>쇼핑정보</h3>
            <ul>
                <li><a th:href="@{/mypage/orders}">주문목록/배송조회</a></li>
                <li><a th:href="@{/mypage/returns}">취소/반품/교환 내역</a></li>
                <li><a th:href="@{/mypage/refund}">환불/입금 내역</a></li>
                <li><a th:href="@{/mypage/wishlist}">위시리스트</a></li>
            </ul>

            <hr/>

            <h3>고객센터</h3>
            <ul>
                <li><a th:href="@{/mypage/inquiry}">1:1 문의</a></li>
            </ul>

            <hr/>

            <h3>회원정보</h3>
            <ul>
                <li><a th:href="@{/mypage/member-edit}">회원정보 변경</a></li>
                <li><a th:href="@{/mypage/withdraw}">회원 탈퇴</a></li>
            </ul>

            <hr/>

            <h3>나의 상품문의</h3>
            <ul>
                <li><a th:href="@{/mypage/product-inquiries}">나의 상품문의</a></li>
            </ul>

            <hr/>

            <h3>나의 상품후기</h3>
            <ul>
                <li><a th:href="@{/reviews/mine}">나의 상품후기</a></li>
            </ul>
        </aside>
        <div class="content-wrapper">
            <section class="order-progress">
                <h2>진행 중인 주문<span class="sub-text">최근 1개월 기준</span></h2>
                <div class="order-status">
                    <div class="step">
                        <span class="count">0</span>
                        <span class="label">결제완료</span>
                    </div>
                    <span class="arrow">></span>
                    <div class="step">
                        <span class="count">0</span>
                        <span class="label">배송준비중</span>
                    </div>
                    <span class="arrow">></span>
                    <div class="step">
                        <span class="count">0</span>
                        <span class="label">배송완료</span>
                    </div>
                    <span class="arrow">></span>
                    <div class="step">
                        <span class="count">0</span>
                        <span class="label">구매확정</span>
                    </div>
                </div>
            </section>

            <section class="recent-orders">
                <h2>최근 주문 정보 <a th:href="@{/mypage/orders}" class="more-link">더보기&gt;</a></h2>
                <table class="order-table">
                    <thead>
                        <tr>
                            <th>날짜/주문번호</th>
                            <th>상품명/옵션</th>
                            <th>상품금액/수량</th>

                        </tr>
                    </thead>
                  <!-- 주문 내역이 없을 때 -->
                <tr th:if="${#lists.isEmpty(orderList)}">
                    <td colspan="5" class="no-data">조회내역이 없습니다.</td>
                </tr>

                <!-- 주문 내역이 있을 때 -->
                <tr th:each="item : ${orderList}">
                    <td>
                        <span th:text="${#temporals.format(item.regDate, 'yyyy-MM-dd')}">2025-07-03</span><br/>
                        주문번호: <span th:text="${item.orderItemId}">12345</span>
                    </td>
                    <td>
                        <img th:src="@{${item.orderImg}}" alt="상품 이미지" style="width: 60px;" /><br/>
                        <span th:text="${item.orderPname}">상품명</span>
                    </td>
                    <td>
                        <span th:text="${#numbers.formatInteger(item.orderPrice, 3, 'COMMA')}">12,000</span>원<br/>
                        <span th:text="${item.orderCount}">1</span>개
                    </td>
                </tbody>

                </table>
            </section>

            <section class="recent-viewed">
                <h2>최근 본 상품</h2>
                <div class="recently-products" id="recent-products">상품이 존재하지 않습니다.</div>
            </section>

        </div>

   </main>

<div th:replace="~{fragments/footer :: my-footer}"></div>
<script th:src="@{/assets/js/logout.js}"></script>

<script th:inline="javascript">
    fetch('/mypage/order-counts')
        .then(res => res.json())
        .then(data => {
            const steps = document.querySelectorAll(".order-status .step");

            steps[0].querySelector(".count").textContent = data["결제완료"];
            steps[1].querySelector(".count").textContent = data["배송준비중"];
            steps[2].querySelector(".count").textContent = data["배송완료"];
            steps[3].querySelector(".count").textContent = data["구매확정"];
        });
</script>

<script>
       const recentContainer = document.getElementById("recent-products");


    console.log("recentContainer:", recentContainer);


      const userId = document.body.dataset.userId; // 사용자 ID 읽기
      console.log("userId:", userId);

    if (!userId) {
      recentContainer.innerHTML = "<div class='no-product'>로그인 정보가 없습니다.</div>";
     } else {
       const storageKey = `recentProducts_${userId}`;
       console.log("Using storageKey:", storageKey);   //recentProducts_16이라고 출력됨..

       const recentJson = localStorage.getItem(storageKey);
console.log("localStorage.getItem:", recentJson);   //null이라 출력됨 여기부터 ㅠ

       const recent = JSON.parse(localStorage.getItem(storageKey) || '[]');
       console.log("recent:", recent);

    if (recent.length === 0) {
      recentContainer.innerHTML = "<div class='no-product'>상품이 존재하지 않습니다.</div>";
    } else {
      const html = recent.map(item =>
        `<div class="product">
          <a href="/products/detail?productId=${item.id}">
            <img src="${item.img}" alt="${item.name}" />
            <p>${item.name}</p>
          </a>
        </div>`).join('');
      recentContainer.innerHTML = html;
    }
  }
</script>

</body>

</html>